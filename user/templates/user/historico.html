{% extends "user/index.html" %}
{% load static %}
{% load crispy_forms_tags %}
{% block start %}

<main class="historic-wrapper">
    <header>
        <h4>Olá, {{ user.last_name }}!</h4>
        <a href="{% url 'index' %}">
            <img src="{% static 'images/shopkeeper/icons/arrow-left.svg' %}" alt="Voltar">
            Retornar
        </a>
    </header>

    <canvas id="monthly"></canvas>

    <div class="line"></div>

    <div class="select-group">
        <select id="years" onchange="getYear(); updateChart()">
            <option value="1">2022</option>
            <option value="2">2023</option>
            <option value="3">2024</option>
            <option value="4">2025</option>
        </select>

        <select id="months" onchange="getMonth(); updateChart()">
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
        </select>
    </div>

    <div class="graphic-container">
        <canvas id="daily"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let counter = 0

        const welcomeMessage = document.querySelector('header h4').textContent
        let name;

        function getName() {
            name = welcomeMessage.replace('Olá, ', '')
            name = name.replace('!', '')

            return name;
        }

        getName()

        let amount = [
            {
                month: "Janeiro",
                value: 0
            },
            {
                month: "Fevereiro",
                value: 0
            },
            {
                month: "Março",
                value: 0
            },
            {
                month: "Abril",
                value: 0
            },
            {
                month: "Maio",
                value: 0
            },
            {
                month: "Junho",
                value: 0
            },
            {
                month: "Julho",
                value: 0
            },
            {
                month: "Agosto",
                value: 0
            },
            {
                month: "Setembro",
                value: 0
            },
            {
                month: "Outubro",
                value: 0
            },
            {
                month: "Novembro",
                value: 0
            },
            {
                month: "Dezembro",
                value: 0
            },
        ]

        const daysOfMonth = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
        ]

        const currentYear = new Date().getFullYear()

        async function getDataMonthly() {
            try {
                const response = await fetch(`https://e-fidelity-backend.herokuapp.com/store/${name}/${currentYear}`)
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        const monthsOfYear = [
                            "Janeiro", "Fevereiro", "Março",
                            "Abril", "Maio", "Junho",
                            "Julho", "Agosto", "Setembro",
                            "Outubro", "Novembro", "Dezembro",
                        ]
                        let expression;
                        let total = 0
                        const results = []

                        for (let i in data) {
                            const selectedMonth = monthsOfYear[parseInt(data[i].Data.slice(3, 5)) - 1]

                            if (data[i].Mês == selectedMonth) {
                                for (let month of monthsOfYear) {
                                    month.includes(String(data[i].Mês)) // results.push({month: month, value: data[i].Valor / 100})
                                        ? results.findIndex(({ month }) => month == data[i].Mês) != -1
                                            ? results.forEach(obj => {
                                                if (obj.month == month) {
                                                    obj.value += data[i].Valor / 100
                                                }
                                            })
                                            : results.push({month: month, value: data[i].Valor / 100})
                                        : ''
                                }
                            }
                        }

                        for (let i = 0; i < results.length; i++) {
                            amount[i].value = results[i].value
                        }

                        console.log(amount)
                    })
            } catch (error) {
                console.log(error)
            }
        }

        async function showMonthlyGraphic() {
            await getDataMonthly()

            const labels = [
                'Janeiro',
                'Fevereiro',
                'Março',
                'Abril',
                'Maio',
                'Junho',
                'Julho',
                'Agosto',
                'Setembro',
                'Outubro',
                'Novembro',
                'Dezembro'
            ];

            const data = {
                labels: labels,
                datasets: [{
                    label: 'Histórico de vendas - Mensal',
                    backgroundColor: 'rgb(69,143,246)',
                    borderColor: 'rgb(69,143,246)',
                    data: handleData()
                }]
            };

            function handleData() {
                const array = []

                for (let i in amount) {
                    array.push(amount[i].value)
                }

                return array;
            }

            const config = {
                type: 'line',
                data: data,
                options: {}
            };

            const myChart = new Chart(
                document.getElementById('monthly'),
                config
            );
        }
    
        showMonthlyGraphic()

        async function getDataDaily() {
            try {
                const response = await fetch(`https://e-fidelity-backend.herokuapp.com/store/${name}/${getYear()}/${getMonth()}`)
                    .then(response => {
                        return response.json()
                    })
                    .then(data => {
                        for (let i = 0; i < daysOfMonth.length; i++) {
                            daysOfMonth[i] = 0
                        }

                        data.map(obj => {
                            let value = obj.Valor

                            const day = Number(obj.Data.slice(0, 2))

                            daysOfMonth[day - 1] += value / 100
                        })
                    })
            } catch (error) {
                console.error(error)
            }
        }

        async function showDailyGraphic() {
            await getDataDaily()

            const labels = [
                1, 2, 3, 4, 5, 6, 7, 8, 9, 10,
                11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
                21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31
            ];

            const data = {
                labels: labels,
                datasets: [{
                    label: 'Histórico de vendas - Diário',
                    backgroundColor: 'rgb(69,143,246)',
                    borderColor: 'rgb(69,143,246)',
                    data: daysOfMonth
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {}
            };

            const myChart = new Chart(
                document.getElementById('daily'),
                config
            );
        }

        function deleteChart() {
            const dailyGraphic = document.getElementById('daily')
            dailyGraphic.remove()
        }

        function updateChart() {
            deleteChart()

            const graphicContainer = document.querySelector('.graphic-container')
            const newCanvas = document.createElement('canvas')
            newCanvas.setAttribute('id', 'daily')
            graphicContainer.appendChild(newCanvas)

            showDailyGraphic()
        }

        showDailyGraphic()

        function getYear() {
            const yearSelected = document.getElementById('years')

            const text = yearSelected.options[yearSelected.selectedIndex].textContent;

            return Number(text);
        }

        function getMonth() {
            const monthSelected = document.getElementById('months')

            const value = monthSelected.options[monthSelected.selectedIndex].value;

            return Number(value);
        }
    </script>
</main>

{% endblock start %}
